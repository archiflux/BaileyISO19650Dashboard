<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Active Projects - Bailey Partnership</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/dashboard.css">
</head>
<body>
  <header class="metadata-bar">
    <div class="metadata-bar__inner">
      <div class="metadata-item">
        <span class="metadata-label">View</span>
        <span class="metadata-value">Active Projects</span>
      </div>
      <div class="metadata-item">
        <span class="metadata-label">Total Projects</span>
        <span class="metadata-value" id="totalProjects">0</span>
      </div>
    </div>
  </header>

  <div class="app-container">
    <nav class="nav-sidebar">
      <div class="nav-logo">
        <h1><a href="../../index.html" style="color: inherit;">ISO19650 Dashboard</a></h1>
        <p style="font-size: 0.75rem; color: #666;">Project Management</p>
      </div>
      <div class="nav-section">
        <a href="#1.0" class="nav-link nav-link--section">1.0 All Projects</a>
      </div>
      <div class="nav-section">
        <a href="project-setup.html" class="btn btn--accent" style="margin: 1rem; width: calc(100% - 2rem);">
          + New Project
        </a>
      </div>
      <div class="nav-section">
        <a href="../../index.html" class="nav-link nav-link--subsection">← Back to Dashboard</a>
      </div>
    </nav>

    <main class="main-content">
      <section id="1.0" class="report-section">
        <div class="section-band">
          <span class="section-number">1.0</span>
          <h2 class="section-title">Active Projects</h2>
        </div>
        <div class="section-content">
          <div class="flex flex-between mb-lg">
            <div class="form-group mb-0" style="flex: 1; max-width: 400px;">
              <input type="text" id="searchProjects" class="form-input" placeholder="Search projects...">
            </div>
            <div class="flex flex-gap-sm">
              <select id="filterPhase" class="form-select" style="min-width: 200px;">
                <option value="">All Phases</option>
                <option value="tender">Tender Response</option>
                <option value="appointment">Appointment</option>
                <option value="mobilisation">Mobilisation</option>
                <option value="production">Collaborative Production</option>
                <option value="delivery">Information Model Delivery</option>
                <option value="closeout">Project Close-out</option>
              </select>
            </div>
          </div>

          <div id="projectsContainer">
            <p class="text-muted text-center">Loading projects...</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Project Detail Modal -->
  <div id="projectModal" class="modal">
    <div class="modal__content" style="max-width: 1000px;">
      <div class="modal__header">
        <h2 class="modal__title">Project Details</h2>
        <button class="modal__close modal-close-btn">×</button>
      </div>
      <div class="modal__body" id="projectModalBody">
        <!-- Content loaded dynamically -->
      </div>
      <div class="modal__footer">
        <button class="btn btn--secondary modal-close-btn">Close</button>
      </div>
    </div>
  </div>

  <script src="../../assets/js/dashboard.js"></script>
  <script>
    let allProjects = [];

    function loadProjects() {
      allProjects = BaileyDB.getProjects();
      document.getElementById('totalProjects').textContent = allProjects.length;
      renderProjects(allProjects);
    }

    function renderProjects(projects) {
      const container = document.getElementById('projectsContainer');

      if (projects.length === 0) {
        container.innerHTML = `
          <div class="card text-center">
            <div class="card__content">
              <p class="text-muted mb-lg">No projects found. Create your first project to get started.</p>
              <a href="project-setup.html" class="btn btn--primary">Create New Project</a>
            </div>
          </div>
        `;
        return;
      }

      const html = `
        <div class="widget widget--full">
          <div class="widget__body widget__body--no-padding">
            <div class="data-table-wrapper">
              <table class="data-table" id="projectsTable">
                <thead>
                  <tr>
                    <th class="sortable">Project Name</th>
                    <th class="sortable">ISO Number</th>
                    <th class="sortable">Client</th>
                    <th class="sortable">Phase</th>
                    <th class="sortable">Role</th>
                    <th class="sortable">Updated</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${projects.map(project => `
                    <tr>
                      <td><strong>${project.projectName}</strong></td>
                      <td><code style="font-size: 0.75rem;">${project.isoNumber || 'N/A'}</code></td>
                      <td>${project.clientName || 'N/A'}</td>
                      <td>
                        <span class="status-badge status-badge--${getPhaseClass(project.projectPhase)}">
                          ${getPhaseLabel(project.projectPhase)}
                        </span>
                      </td>
                      <td>${getRoleLabel(project.baileyRole)}</td>
                      <td>${new Date(project.updatedAt).toLocaleDateString()}</td>
                      <td>
                        <button class="btn btn--small btn--secondary" onclick="viewProject('${project.id}')">
                          View
                        </button>
                        <button class="btn btn--small btn--danger" onclick="deleteProject('${project.id}')">
                          Delete
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;

      container.innerHTML = html;
      TableUtils.makeSortable(document.getElementById('projectsTable'));
    }

    function getPhaseLabel(phase) {
      const labels = {
        'tender': 'Tender',
        'appointment': 'Appointment',
        'mobilisation': 'Mobilisation',
        'production': 'Production',
        'delivery': 'Delivery',
        'closeout': 'Close-out'
      };
      return labels[phase] || phase;
    }

    function getPhaseClass(phase) {
      const classes = {
        'tender': 'warning',
        'appointment': 'info',
        'mobilisation': 'info',
        'production': 'success',
        'delivery': 'success',
        'closeout': 'neutral'
      };
      return classes[phase] || 'neutral';
    }

    function getRoleLabel(role) {
      const labels = {
        'lead_appointed': 'Lead Appointed Party',
        'appointed': 'Appointed Party',
        'consultant': 'Consultant'
      };
      return labels[role] || role;
    }

    function viewProject(id) {
      const project = BaileyDB.getProject(id);
      if (!project) {
        Notifications.show('Project not found', 'danger');
        return;
      }

      const modalBody = document.getElementById('projectModalBody');
      modalBody.innerHTML = `
        <div class="widget-grid widget-grid--2col">
          <div>
            <h4 class="mb-md">Project Information</h4>
            <table class="data-table">
              <tbody>
                <tr>
                  <td><strong>Project Name</strong></td>
                  <td>${project.projectName}</td>
                </tr>
                <tr>
                  <td><strong>Project Number</strong></td>
                  <td>${project.projectNumber || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>ISO Number</strong></td>
                  <td><code>${project.isoNumber}</code></td>
                </tr>
                <tr>
                  <td><strong>Client</strong></td>
                  <td>${project.clientName}</td>
                </tr>
                <tr>
                  <td><strong>Location</strong></td>
                  <td>${project.projectLocation || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Value</strong></td>
                  <td>${project.projectValue ? '£' + parseInt(project.projectValue).toLocaleString() : 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Start Date</strong></td>
                  <td>${project.projectStartDate || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Type</strong></td>
                  <td>${project.projectType || 'N/A'}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div>
            <h4 class="mb-md">ISO19650 Details</h4>
            <table class="data-table">
              <tbody>
                <tr>
                  <td><strong>Current Phase</strong></td>
                  <td><span class="status-badge status-badge--${getPhaseClass(project.projectPhase)}">${getPhaseLabel(project.projectPhase)}</span></td>
                </tr>
                <tr>
                  <td><strong>Bailey Role</strong></td>
                  <td>${getRoleLabel(project.baileyRole)}</td>
                </tr>
                <tr>
                  <td><strong>CDE Provider</strong></td>
                  <td>${project.cdeProvider || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Project Lead</strong></td>
                  <td>${project.projectLead || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>BIM Manager</strong></td>
                  <td>${project.bimManager || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Task Team Manager</strong></td>
                  <td>${project.taskTeamManager || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Document Controller</strong></td>
                  <td>${project.documentController || 'N/A'}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        ${project.projectDescription ? `
          <div class="mt-lg">
            <h4 class="mb-md">Description</h4>
            <p>${project.projectDescription}</p>
          </div>
        ` : ''}

        ${project.teamNotes ? `
          <div class="mt-lg">
            <h4 class="mb-md">Team Notes</h4>
            <p>${project.teamNotes}</p>
          </div>
        ` : ''}

        <div class="mt-lg">
          <h4 class="mb-md">Quick Actions</h4>
          <div class="flex flex-gap-sm">
            <a href="raci-matrix.html" class="btn btn--primary">Create RACI Matrix</a>
            <a href="bep-generator.html" class="btn btn--secondary">Generate BEP</a>
          </div>
        </div>

        <div class="mt-lg">
          <p class="text-muted text-small">
            <strong>Created:</strong> ${new Date(project.createdAt).toLocaleString()}<br>
            <strong>Last Updated:</strong> ${new Date(project.updatedAt).toLocaleString()}
          </p>
        </div>
      `;

      ModalUtils.open('projectModal');
    }

    function deleteProject(id) {
      if (confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        BaileyDB.deleteProject(id);
        Notifications.show('Project deleted successfully', 'success');
        loadProjects();
      }
    }

    // Search functionality
    document.getElementById('searchProjects').addEventListener('input', function(e) {
      filterProjects();
    });

    // Phase filter
    document.getElementById('filterPhase').addEventListener('change', function(e) {
      filterProjects();
    });

    function filterProjects() {
      const searchText = document.getElementById('searchProjects').value.toLowerCase();
      const phaseFilter = document.getElementById('filterPhase').value;

      let filtered = allProjects;

      // Filter by search text
      if (searchText) {
        filtered = filtered.filter(project => {
          return project.projectName.toLowerCase().includes(searchText) ||
                 (project.clientName && project.clientName.toLowerCase().includes(searchText)) ||
                 (project.isoNumber && project.isoNumber.toLowerCase().includes(searchText));
        });
      }

      // Filter by phase
      if (phaseFilter) {
        filtered = filtered.filter(project => project.projectPhase === phaseFilter);
      }

      renderProjects(filtered);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadProjects();
    });
  </script>
</body>
</html>
